<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moderator - Advanced Contest Creator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --sidebar-bg: rgba(30, 41, 59, 0.95);
            --sidebar-hover: rgba(51, 65, 85, 0.4);
            --text-main: #1e293b;
            --text-muted: #64748b;
            --white: #ffffff;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        * { box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; padding: 0; }
        
        body { 
            background-color: #f8f9fa;
            background-image: 
                radial-gradient(at 0% 0%, hsla(214,100%,92%,1) 0, transparent 50%), 
                radial-gradient(at 100% 100%, hsla(220,100%,94%,1) 0, transparent 50%),
                radial-gradient(at 50% 50%, hsla(214,100%,96%,1) 0, transparent 50%);
            min-height: 100vh; 
            padding: 20px; 
        }

        .main-container { 
            width: 100%; 
            height: calc(100vh - 40px); 
            background: rgba(255, 255, 255, 0.8); 
            backdrop-filter: blur(12px);
            border-radius: 24px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.1); 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .header { 
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); 
            color: white; 
            padding: 20px 40px; 
            flex-shrink: 0; 
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left { display: flex; align-items: center; gap: 20px; }
        .logo-img { height: 50px; width: 50px; border-radius: 12px; object-fit: cover; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .header h1 { font-size: 24px; font-weight: 800; letter-spacing: -0.5px; }

        .content-grid { display: grid; grid-template-columns: 270px 1fr; flex: 1; overflow: hidden; }

        .sidebar { background: var(--sidebar-bg); padding: 30px 20px; overflow-y: auto; display: flex; flex-direction: column; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 14px 18px; color: #cbd5e1; text-decoration: none; border-radius: 12px; margin-bottom: 8px; transition: all 0.3s ease; font-weight: 500; cursor: pointer; }
        .nav-item:hover { background: var(--sidebar-hover); color: white; transform: translateX(5px); }
        .nav-item.active { background: var(--primary); color: white; box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.3); }

        .main-content { padding: 40px; overflow-y: auto; display: flex; flex-direction: column; gap: 30px; }
        .content-section { background: rgba(255, 255, 255, 0.9); border-radius: 20px; padding: 30px; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05); border: 1px solid rgba(255, 255, 255, 0.5); margin-bottom: 20px; }
        
        label { display: block; font-weight: 700; color: var(--text-muted); margin-bottom: 8px; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; }
        input, select, textarea { width: 100%; padding: 14px 16px; border: 1.5px solid #e2e8f0; border-radius: 12px; font-size: 15px; transition: all 0.2s; background: white; margin-bottom: 10px; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1); }

        .btn { padding: 14px 28px; border-radius: 12px; border: none; font-size: 15px; font-weight: 700; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 10px; justify-content: center; }
        .btn-sm { padding: 8px 16px; font-size: 12px; border-radius: 8px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-danger { background: var(--danger); color: white; }

        .contest-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        .contest-table th { text-align: left; padding: 12px 20px; color: var(--text-muted); font-size: 12px; text-transform: uppercase; }
        .contest-row { background: white; transition: 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .contest-row:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .contest-row td { padding: 20px; border-top: 1px solid #f1f5f9; border-bottom: 1px solid #f1f5f9; }
        .contest-row td:first-child { border-left: 1px solid #f1f5f9; border-radius: 12px 0 0 12px; }
        .contest-row td:last-child { border-right: 1px solid #f1f5f9; border-radius: 0 12px 12px 0; }

        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
        .status-active { background: #ecfdf5; color: #10b981; }
        .status-held { background: #fef3c7; color: #d97706; }

        .tc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; background: #f1f5f9; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        .upload-area { border: 2px dashed var(--primary); padding: 50px 30px; text-align: center; border-radius: 20px; background: rgba(99, 102, 241, 0.03); cursor: pointer; transition: 0.3s; margin-bottom: 20px; }
        .upload-area.dragover { background: rgba(99, 102, 241, 0.15); border-color: var(--primary-dark); transform: scale(1.01); }
        .problem-item { background: white; border: 1px solid #e2e8f0; padding: 18px; border-radius: 15px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        .hidden-section { display: none !important; }
        .spinner { width: 24px; height: 24px; border: 3px solid rgba(99, 102, 241, 0.2); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .toast { position: fixed; bottom: 30px; right: 30px; padding: 16px 24px; border-radius: 12px; color: white; font-weight: 700; box-shadow: 0 10px 25px rgba(0,0,0,0.1); z-index: 1000; display: flex; align-items: center; gap: 10px; }
        .toast-success { background: var(--success); }
        .toast-error { background: var(--danger); }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="header">
            <div class="header-left">
                <img src="logo.jpg" alt="Logo" class="logo-img">
                <div>
                    <h1>Advanced Contest Creator</h1>
                    <p style="color: #94a3b8; font-size: 13px;">Manage, Edit, and Control Contest Status</p>
                </div>
            </div>
        </div>
        
        <div class="content-grid">
            <div class="sidebar">
                <a class="nav-item" href="moderator.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                <a class="nav-item active" id="navCreate" onclick="switchTab('create')"><i class="fas fa-plus-circle"></i> Create/Edit Contest</a>
                <a class="nav-item" id="navManage" onclick="switchTab('manage')"><i class="fas fa-tasks"></i> Manage Contests</a>
                <a class="nav-item" href="create-debug-contest.html"><i class="fas fa-bug"></i> Debug Contest</a>
                <a class="nav-item" id="exportBtn" onclick="exportActualScores()"><i class="fas fa-file-export"></i> Download Actual Scores</a>
                <a class="nav-item" onclick="logout()" style="margin-top: auto; color: #f87171;"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </div>
            
            <div class="main-content">
                <div id="createSection">
                    <div class="content-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3><i class="fas fa-cog"></i> 1. Contest Configuration</h3>
                            <button id="cancelEditBtn" class="btn btn-danger btn-sm hidden-section" onclick="resetForm()">Cancel Edit</button>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <label>Contest Name *</label>
                                <input type="text" id="contestName" placeholder="e.g., Python Certification 2026">
                            </div>
                            <div>
                                <label>Duration (minutes)</label>
                                <input type="number" id="timeLimit" value="120">
                            </div>
                        </div>
                    </div>
                    
                    <div class="content-section">
                        <h3><i class="fas fa-tasks"></i> 2. Problem Set Construction</h3>
                        <div class="form-group" style="margin-bottom: 25px;">
                            <label>Creation Method</label>
                            <select id="methodSelect" onchange="toggleCreationMethod()" style="font-weight: 700; border-color: var(--primary);">
                                <option value="manual">Manual Form (2 Sample, 5 Hidden TCs)</option>
                                <option value="ai">Generative AI (Topic-based)</option>
                                <option value="document">Document Mode (File Drag & Drop)</option>
                            </select>
                        </div>

                        <div id="aiArea" class="hidden-section">
                            <div style="border: 1px solid #e2e8f0; padding: 30px; border-radius: 20px; background: #fff;">
                                <label>Problem Topic</label>
                                <input type="text" id="aiTopic" placeholder="e.g. Recursion, Binary Search Trees">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div>
                                        <label>Difficulty</label>
                                        <select id="aiDifficulty">
                                            <option value="Easy">Easy</option>
                                            <option value="Medium" selected>Medium</option>
                                            <option value="Hard">Hard</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label>Language Focus</label>
                                        <select id="aiLanguage">
                                            <option value="python">Python</option>
                                            <option value="java">Java</option>
                                            <option value="cpp">C++</option>
                                        </select>
                                    </div>
                                </div>
                                <button class="btn btn-primary" onclick="generateAIProblems()" id="aiGenBtn" style="width: 100%;">
                                    <i class="fas fa-magic"></i> Auto-Generate Problem Set
                                </button>
                            </div>
                        </div>

                        <div id="documentArea" class="hidden-section">
                            <div class="upload-area" id="dropZone" onclick="document.getElementById('fileInput').click()">
                                <i class="fas fa-file-import fa-4x" style="color: var(--primary); margin-bottom: 15px;"></i>
                                <p id="dropText" style="font-weight: 700; font-size: 18px;">Drag & Drop CSV/TXT Document</p>
                                <input type="file" id="fileInput" hidden accept=".csv,.txt" onchange="handleFileSelect(this.files)">
                            </div>
                        </div>

                        <div id="manualArea" style="border: 1px solid #e2e8f0; padding: 30px; border-radius: 20px; background: #fff;">
                            <label>Problem Statement (Title)</label>
                            <input type="text" id="qTitle" placeholder="Problem title here">
                            <label>Description & Constraints</label>
                            <textarea id="qDescription" placeholder="Enter problem statement..." rows="5"></textarea>
                            
                            <h4 style="color: var(--primary); margin: 20px 0 10px 0; font-weight: 800; font-size: 14px;">VISIBLE SAMPLE CASES (Exactly 2)</h4>
                            <div class="tc-grid">
                                <input type="text" id="sIn1" placeholder="S1 Input">
                                <input type="text" id="sOut1" placeholder="S1 Output">
                                <input type="text" id="sIn2" placeholder="S2 Input">
                                <input type="text" id="sOut2" placeholder="S2 Output">
                            </div>

                            <h4 style="color: var(--danger); margin: 20px 0 10px 0; font-weight: 800; font-size: 14px;">SECRET HIDDEN CASES (Exactly 5)</h4>
                            <div id="hiddenTestContainer">
                                <div class="tc-grid"><input type="text" class="h-in" placeholder="Hidden 1 Input"><input type="text" class="h-out" placeholder="Hidden 1 Output"></div>
                                <div class="tc-grid"><input type="text" class="h-in" placeholder="Hidden 2 Input"><input type="text" class="h-out" placeholder="Hidden 2 Output"></div>
                                <div class="tc-grid"><input type="text" class="h-in" placeholder="Hidden 3 Input"><input type="text" class="h-out" placeholder="Hidden 3 Output"></div>
                                <div class="tc-grid"><input type="text" class="h-in" placeholder="Hidden 4 Input"><input type="text" class="h-out" placeholder="Hidden 4 Output"></div>
                                <div class="tc-grid"><input type="text" class="h-in" placeholder="Hidden 5 Input"><input type="text" class="h-out" placeholder="Hidden 5 Output"></div>
                            </div>

                            <button class="btn btn-success" onclick="addManualProblem()" style="width: 100%; height: 50px;">
                                <i class="fas fa-save"></i> Add to Contest Problem List
                            </button>
                        </div>

                        <div id="problemListDisplay" style="margin-top: 30px;"></div>
                        
                        <button class="btn btn-primary" onclick="launchContest()" id="launchBtn" style="margin-top: 25px; width: 100%; height: 65px; font-size: 18px; border-radius: 16px;">
                            <i class="fas fa-rocket"></i> Finalize & Deploy Contest
                        </button>
                    </div>
                </div>

                <div id="manageSection" class="hidden-section">
                    <div class="content-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3><i class="fas fa-list"></i> Active Regular Contests</h3>
                            <button class="btn btn-primary btn-sm" onclick="fetchContests()"><i class="fas fa-sync"></i> Refresh</button>
                        </div>
                        
                        <table class="contest-table">
                            <thead>
                                <tr>
                                    <th>Contest Name</th>
                                    <th>Problems</th>
                                    <th>Status</th>
                                    <th>Created On</th>
                                    <th style="text-align: right;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="contestTableBody">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="toastContainer"></div>

    <script>
        const isLocal = window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1";
        const API_URL = isLocal ? "http://localhost:5000/api" : "http://3.108.67.225:5000/api";
        const token = localStorage.getItem('token');
        
        let currentProblems = [];
        let isEditMode = false;
        let editingContestId = null;

        if (!token) window.location.href = 'index.html';

        function switchTab(tab) {
            const createSec = document.getElementById('createSection');
            const manageSec = document.getElementById('manageSection');
            const navCreate = document.getElementById('navCreate');
            const navManage = document.getElementById('navManage');

            if(tab === 'create') {
                createSec.classList.remove('hidden-section');
                manageSec.classList.add('hidden-section');
                navCreate.classList.add('active');
                navManage.classList.remove('active');
            } else {
                createSec.classList.add('hidden-section');
                manageSec.classList.remove('hidden-section');
                navCreate.classList.remove('active');
                navManage.classList.add('active');
                fetchContests();
            }
        }

        async function fetchContests() {
            const tbody = document.getElementById('contestTableBody');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center"><div class="spinner"></div> Loading...</td></tr>';
            
            try {
                const res = await fetch(`${API_URL}/moderator/contests`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await res.json();
                
                if(result.success) {
                    if(result.data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 40px; color: #64748b;">No active contests found.</td></tr>';
                        return;
                    }
                    
                    tbody.innerHTML = result.data.map(c => {
                        const isHeld = c.status === 'held';
                        const statusClass = isHeld ? 'status-held' : 'status-active';
                        
                        return `
                            <tr class="contest-row">
                                <td>
                                    <div style="font-weight:700">${c.title}</div>
                                    <div style="font-size:11px; color:#64748b">${c.contest_id}</div>
                                </td>
                                <td>${c.problems_count} Problems</td>
                                <td><span class="status-badge ${statusClass}">${c.status}</span></td>
                                <td>${new Date(c.created_at).toLocaleDateString()}</td>
                                <td style="text-align: right; display: flex; gap: 8px; justify-content: flex-end;">
                                    <button class="btn btn-success btn-sm" onclick="exportContestReport('${c.contest_id}')" title="Export CSV">
                                        <i class="fas fa-file-csv"></i>
                                    </button>
                                    <button class="btn ${isHeld ? 'btn-success' : 'btn-warning'} btn-sm" 
                                            onclick="toggleContestStatus('${c.contest_id}', '${isHeld ? 'active' : 'held'}')"
                                            title="${isHeld ? 'Release' : 'Hold'}">
                                        <i class="fas ${isHeld ? 'fa-play' : 'fa-pause'}"></i>
                                    </button>
                                    <button class="btn btn-primary btn-sm" onclick="editContest('${c.contest_id}')" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteContest('${c.contest_id}')" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }
            } catch (e) {
                showToast("Failed to fetch contests", "error");
            }
        }

        async function exportContestReport(contestId) {
            try {
                showToast("Generating report...", "success");
                const response = await fetch(`${API_URL}/moderator/contest/${contestId}/export-csv`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Export failed');

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Results_Contest_${contestId}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
            } catch (e) {
                showToast("Error exporting contest report", "error");
            }
        }

        async function toggleContestStatus(id, newStatus) {
            try {
                const res = await fetch(`${API_URL}/moderator/contest/${id}/status`, {
                    method: 'PATCH',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` 
                    },
                    body: JSON.stringify({ status: newStatus })
                });
                const result = await res.json();
                if (result.success) {
                    showToast(result.message, "success");
                    fetchContests();
                } else {
                    showToast(result.message, "error");
                }
            } catch (e) {
                showToast("Connection failed", "error");
            }
        }

        async function editContest(id) {
            try {
                const res = await fetch(`${API_URL}/moderator/contest/${id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await res.json();
                
                if(result.success) {
                    const contest = result.data;
                    isEditMode = true;
                    editingContestId = id;

                    switchTab('create');
                    
                    document.getElementById('contestName').value = contest.name;
                    document.getElementById('timeLimit').value = contest.metadata?.time_limit || 120;
                    currentProblems = contest.problems || [];
                    renderProblems();

                    document.getElementById('cancelEditBtn').classList.remove('hidden-section');
                    const launchBtn = document.getElementById('launchBtn');
                    launchBtn.innerHTML = '<i class="fas fa-save"></i> Update & Save Changes';
                    launchBtn.className = 'btn btn-success';
                    launchBtn.style.marginTop = '25px';
                    launchBtn.style.width = '100%';
                    launchBtn.style.height = '65px';
                }
            } catch (e) {
                showToast("Error loading contest data", "error");
            }
        }

        function resetForm() {
            isEditMode = false;
            editingContestId = null;
            currentProblems = [];
            document.getElementById('contestName').value = '';
            document.getElementById('timeLimit').value = '120';
            document.getElementById('cancelEditBtn').classList.add('hidden-section');
            renderProblems();
            
            const launchBtn = document.getElementById('launchBtn');
            launchBtn.innerHTML = '<i class="fas fa-rocket"></i> Finalize & Deploy Contest';
            launchBtn.className = 'btn btn-primary';
        }

        async function deleteContest(id) {
            if(!confirm("Delete this contest? All progress will be lost.")) return;
            try {
                const res = await fetch(`${API_URL}/moderator/contest/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await res.json();
                if(result.success) {
                    showToast("Contest deleted", "success");
                    fetchContests();
                }
            } catch (e) {
                showToast("Delete failed", "error");
            }
        }

        function toggleCreationMethod() {
            const method = document.getElementById('methodSelect').value;
            const areas = {
                manual: document.getElementById('manualArea'),
                ai: document.getElementById('aiArea'),
                document: document.getElementById('documentArea')
            };
            Object.keys(areas).forEach(key => {
                if (key === method) {
                    areas[key].classList.remove('hidden-section');
                    areas[key].style.display = 'block';
                } else {
                    areas[key].classList.add('hidden-section');
                    areas[key].style.display = 'none';
                }
            });
        }

        async function generateAIProblems() {
            const topic = document.getElementById('aiTopic').value;
            if(!topic) return showToast("Please specify a topic", "error");
            const btn = document.getElementById('aiGenBtn');
            btn.disabled = true; btn.innerHTML = '<div class="spinner"></div> Generating...';
            try {
                const response = await fetch(`${API_URL}/moderator/generate-problems`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ topic, difficulty: document.getElementById('aiDifficulty').value, language: document.getElementById('aiLanguage').value, count: 5 })
                });
                const result = await response.json();
                if(result.success) {
                    currentProblems = [...currentProblems, ...result.data];
                    renderProblems();
                    showToast("Successfully generated 5 problems", "success");
                }
            } catch(e) { showToast("AI Engine unavailable", "error"); }
            finally { btn.disabled = false; btn.innerHTML = '<i class="fas fa-magic"></i> Auto-Generate Problem Set'; }
        }

        function addManualProblem() {
            const title = document.getElementById('qTitle').value;
            const desc = document.getElementById('qDescription').value;
            if(!title || !desc) return showToast('Title and description are mandatory', 'error');

            const testCases = [];
            const sIn1 = document.getElementById('sIn1').value;
            const sOut1 = document.getElementById('sOut1').value;
            const sIn2 = document.getElementById('sIn2').value;
            const sOut2 = document.getElementById('sOut2').value;

            if(sIn1 && sOut1) testCases.push({ input: sIn1, output: sOut1, is_sample: true });
            if(sIn2 && sOut2) testCases.push({ input: sIn2, output: sOut2, is_sample: true });

            const hIns = document.querySelectorAll('.h-in');
            const hOuts = document.querySelectorAll('.h-out');
            let hCount = 0;
            hIns.forEach((inp, i) => {
                if(inp.value && hOuts[i].value) {
                    testCases.push({ input: inp.value, output: hOuts[i].value, is_sample: false });
                    hCount++;
                }
            });

            if(testCases.filter(t => t.is_sample).length < 2 || hCount < 5) {
                return showToast('Strictly 2 Samples and 5 Hidden cases required', 'error');
            }

            currentProblems.push({ title, description: desc, test_cases: testCases, score: 20 });
            renderProblems();
            showToast('Problem added', 'success');
            document.getElementById('qTitle').value = '';
            document.getElementById('qDescription').value = '';
            document.querySelectorAll('#manualArea input').forEach(i => i.value = '');
        }

        function renderProblems() {
            const container = document.getElementById('problemListDisplay');
            if(currentProblems.length === 0) return container.innerHTML = '';
            container.innerHTML = currentProblems.map((p, i) => `
                <div class="problem-item">
                    <div><strong>${i+1}. ${p.title}</strong></div>
                    <button class="btn btn-danger" onclick="currentProblems.splice(${i},1);renderProblems();"><i class="fas fa-trash"></i></button>
                </div>`).join('');
        }

        async function launchContest() {
            const name = document.getElementById('contestName').value;
            if(!name || currentProblems.length === 0) return showToast('Name and problems required', 'error');
            
            const btn = document.getElementById('launchBtn');
            btn.disabled = true; 
            btn.innerHTML = isEditMode ? '<div class="spinner"></div> Updating...' : '<div class="spinner"></div> Deploying...';

            const url = isEditMode ? `${API_URL}/moderator/contest/${editingContestId}` : `${API_URL}/moderator/create-contest`;
            const method = isEditMode ? 'PATCH' : 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ 
                        name, 
                        problems: currentProblems, 
                        time_limit: document.getElementById('timeLimit').value 
                    })
                });
                const data = await response.json();
                if(data.success) {
                    showToast(isEditMode ? 'Contest updated!' : 'Contest deployed!', 'success');
                    resetForm();
                    switchTab('manage');
                } else {
                    showToast(data.message, "error");
                }
            } catch (e) { showToast('Operation error', 'error'); }
            finally { btn.disabled = false; btn.innerHTML = isEditMode ? '<i class="fas fa-save"></i> Update & Save Changes' : '<i class="fas fa-rocket"></i> Finalize & Deploy Contest'; }
        }

        async function handleFileSelect(files) {
            if (files.length === 0) return;
            const file = files[0];
            const reader = new FileReader();
            const dropText = document.getElementById('dropText');
            dropText.innerHTML = `<div class="spinner"></div> Processing ${file.name}...`;

            reader.onload = async (e) => {
                const content = e.target.result;
                try {
                    const response = await fetch(`${API_URL}/moderator/process-document`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ documentContent: content, language: 'python' })
                    });
                    const result = await response.json();
                    if (result.success) {
                        currentProblems = [...currentProblems, ...result.data.problems];
                        renderProblems();
                        showToast(`Extracted ${result.data.count} problems`, "success");
                    }
                } catch (err) { showToast("Upload failed", "error"); }
                finally { dropText.innerHTML = `Drag & Drop CSV/TXT Document`; }
            };
            reader.readAsText(file);
        }

        document.addEventListener('DOMContentLoaded', () => {
            const dropZone = document.getElementById('dropZone');
            if (!dropZone) return;
            ['dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, (e) => { e.preventDefault(); e.stopPropagation(); });
            });
            dropZone.addEventListener('dragover', () => dropZone.classList.add('dragover'));
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
            dropZone.addEventListener('drop', (e) => {
                dropZone.classList.remove('dragover');
                handleFileSelect(e.dataTransfer.files);
            });
        });

        function showToast(msg, type) {
            const t = document.createElement('div');
            t.className = `toast toast-${type}`;
            t.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${msg}`;
            document.getElementById('toastContainer').appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }
        async function exportActualScores() {
    const btn = document.getElementById('exportBtn');
    try {
        btn.style.opacity = "0.5";
        btn.style.pointerEvents = "none";

        const response = await fetch(`${API_URL}/moderator/export-scores`, {
            method: 'GET',
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('API response was not ok');

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Global_Aggregated_Scores.csv`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        
        showToast("Aggregated scores exported successfully", "success");
    } catch (e) {
        showToast("Failed to export scores.", "error");
    } finally {
        btn.style.opacity = "1";
        btn.style.pointerEvents = "auto";
    }
}

        function logout() { localStorage.clear(); window.location.href = 'index.html'; }
    </script>
</body>
</html>
