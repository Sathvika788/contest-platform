<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ContestPro - IDE Workspace</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/dracula.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --slate-900: #0f172a;
            --slate-800: #1e293b;
            --slate-700: #334155;
            --text-main: #f8fafc;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background-color: var(--slate-900); color: var(--text-main); display: flex; height: 100vh; overflow: hidden; }

        .sidebar { width: 320px; background: var(--slate-800); border-right: 1px solid var(--slate-700); display: flex; flex-direction: column; flex-shrink: 0; }
        .sidebar-header { padding: 25px; border-bottom: 1px solid var(--slate-700); }
        .logo-img { height: 40px; border-radius: 8px; margin-right: 10px; }
        .problem-list { flex: 1; overflow-y: auto; padding: 15px; }
        .problem-item { padding: 15px; margin-bottom: 10px; border-radius: 12px; cursor: pointer; background: var(--slate-700); transition: 0.3s; border: 1px solid transparent; display: flex; align-items: center; gap: 10px; }
        .problem-item.active { background: var(--primary); border-color: white; }
        .problem-item.locked { opacity: 0.6; cursor: not-allowed; border-left: 4px solid var(--danger); }
        .status-dot { height: 10px; width: 10px; border-radius: 50%; flex-shrink: 0; }
        .status-passed { background: var(--success); box-shadow: 0 0 8px var(--success); }
        .status-pending { background: #94a3b8; }
        .status-locked { background: var(--danger); }

        .main-content { flex: 1; display: flex; flex-direction: column; background: #f1f5f9; color: var(--slate-900); }
        .top-bar { padding: 15px 30px; background: white; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .content-area { flex: 1; display: flex; padding: 20px; gap: 20px; overflow: hidden; }
        
        .problem-details { flex: 1; overflow-y: auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        .editor-container { flex: 1.4; display: flex; flex-direction: column; gap: 15px; height: 100%; }
        #editor { flex: 1; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.1); background: #282a36; min-height: 300px; }
        .CodeMirror { height: 100% !important; font-size: 14px; }
        
        .sample-box { background: #f8fafc; border: 1px solid #e2e8f0; padding: 12px; border-radius: 10px; margin-top: 10px; font-family: 'Courier New', monospace; font-size: 13px; white-space: pre-wrap; }
        .controls { display: flex; gap: 12px; }
        .btn { padding: 12px 24px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 8px; }
        .btn-secondary { background: #e2e8f0; color: var(--slate-800); justify-content: center; }
        .btn-secondary:hover { background: #cbd5e1; }
        .btn-submit { background: var(--primary); color: white; width: 100%; justify-content: center; }
        .btn-submit:disabled { background: #94a3b8; cursor: not-allowed; transform: none; }
        .btn-submit:hover:not(:disabled) { background: var(--primary-dark); transform: translateY(-1px); }
        .btn-end { background: var(--danger); color: white; }
        .btn-end:hover { background: #dc2626; }

        .output-box { background: var(--slate-900); color: #e2e8f0; padding: 20px; border-radius: 0 0 15px 15px; font-family: monospace; height: 180px; overflow-y: auto; border-top: 2px solid var(--primary); }
        
        .timer-box { display: flex; align-items: center; gap: 10px; background: #fff1f2; padding: 8px 15px; border-radius: 10px; color: var(--danger); border: 1px solid #fecaca; font-weight: 800; }
        .timer-box.warning { background: #fffbeb; color: var(--warning); border-color: #fef3c7; }

        .custom-input-area { margin-top: 10px; display: none; }
        .custom-input-area textarea { width: 100%; height: 80px; padding: 10px; border-radius: 8px; border: 1px solid #cbd5e1; font-family: monospace; }

        .attempt-badge { background: #fee2e2; color: #ef4444; padding: 2px 8px; border-radius: 5px; font-size: 11px; font-weight: 700; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        .loading-screen { position: fixed; inset: 0; background: var(--slate-900); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="loadingScreen" class="loading-screen">
        <div class="spinner"></div>
        <p id="loadingText" style="margin-top: 15px; color: #94a3b8;">Syncing Workspace...</p>
    </div>

    <div class="sidebar">
        <div class="sidebar-header">
            <div style="display: flex; align-items: center;">
                <img src="logo.jpg" alt="Logo" class="logo-img" onerror="this.src='https://via.placeholder.com/40'">
                <span style="font-size: 20px; font-weight: 800; color: var(--primary);">ContestPro</span>
            </div>
        </div>
        <div class="problem-list" id="problemList"></div>
        <div style="padding: 20px; border-top: 1px solid var(--slate-700); display: flex; flex-direction: column; gap: 10px;">
            <button onclick="endContest()" class="btn btn-end">
                <i class="fas fa-flag-checkered"></i> Finish Contest
            </button>
            <button onclick="exitContest()" class="btn btn-secondary">
                <i class="fas fa-sign-out-alt"></i> Exit IDE
            </button>
        </div>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <div>
                <h2 id="currentProblemTitle">Select a Problem</h2>
                <div id="attemptStatus" style="font-size: 12px; margin-top: 4px; color: var(--slate-700);"></div>
            </div>
            <div style="display: flex; gap: 15px; align-items: center;">
                <div id="scoreDisplay" style="background: #f1f5f9; padding: 8px 15px; border-radius: 10px; font-weight: 800; color: var(--primary);">
                    Score: 0 / 0
                </div>
                <div id="timerContainer" class="timer-box">
                    <i class="fas fa-clock"></i>
                    <span id="timerText">--:--</span>
                </div>
                <button class="btn btn-submit" id="mainSubmitBtn" onclick="submitSolution()">
                    <i class="fas fa-cloud-upload-alt"></i> Submit Problem
                </button>
            </div>
        </div>
        
        <div class="content-area">
            <div class="problem-details" id="problemDescription">
                <div style="text-align: center; padding-top: 50px; color: #94a3b8;">
                    <i class="fas fa-terminal fa-3x" style="margin-bottom: 20px;"></i>
                    <p>Select a challenge from the sidebar to begin.</p>
                </div>
            </div>

            <div class="editor-container">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <select id="langSelect" style="padding: 8px 15px; border-radius: 8px; border: 1px solid #cbd5e1; font-weight: 600;">
                        <option value="python">Python 3</option>
                        <option value="cpp">C++</option>
                        <option value="java">Java</option>
                    </select>
                    <label style="font-size: 13px; color: var(--slate-700); display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="checkbox" id="toggleCustomInput" onchange="toggleInputArea()"> Custom Input
                    </label>
                </div>

                <div class="custom-input-area" id="inputArea">
                    <textarea id="customStdin" placeholder="Enter standard input here..."></textarea>
                </div>

                <div id="editor"></div>

                <div class="controls">
                    <button class="btn btn-secondary" style="flex: 1;" id="runBtn" onclick="runCustomCode()">
                        <i class="fas fa-play"></i> Run Code
                    </button>
                    <button class="btn btn-secondary" style="flex: 1;" id="sampleBtn" onclick="runSampleTests()">
                        <i class="fas fa-vials"></i> Run Samples
                    </button>
                </div>

                <div id="outputContainer">
                    <div style="background: var(--slate-800); color: white; padding: 10px 20px; border-radius: 15px 15px 0 0; font-size: 11px; font-weight: 800;">
                        OUTPUT CONSOLE
                    </div>
                    <div id="outputBox" class="output-box">Execution results will appear here...</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/clike/clike.min.js"></script>

    <script>
        const isLocal = window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1";
        const API_URL = isLocal ? "http://localhost:5000/api" : "http://3.108.67.225:5000/api";
        
        const urlParams = new URLSearchParams(window.location.search);
        const contestId = urlParams.get('id');
        const token = localStorage.getItem('token');
        
        let contestData = null;
        let selectedProblemIndex = null;
        let editor = null;
        let timerInterval = null;

        async function init() {
            if (!token) { window.location.href = 'index.html'; return; }
            if (!contestId) { window.location.href = 'student_dashboard.html'; return; }

            editor = CodeMirror(document.getElementById("editor"), {
                lineNumbers: true,
                theme: "dracula",
                mode: "python",
                indentUnit: 4,
                lineWrapping: true,
                autofocus: true
            });

            document.getElementById('langSelect').addEventListener('change', (e) => {
                const mode = e.target.value === 'python' ? 'python' : 'text/x-c++src';
                editor.setOption("mode", mode);
            });

            editor.on('change', () => {
                if (selectedProblemIndex !== null && !editor.getOption("readOnly")) {
                    localStorage.setItem(`draft_${contestId}_${selectedProblemIndex}`, editor.getValue());
                }
            });

            await loadContest();
        }

        async function loadContest() {
            try {
                const response = await fetch(`${API_URL}/student/contest/${contestId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();
                if (result.success) {
                    contestData = result.data;
                    renderProblemList();
                    updateScoreDisplay();
                    
                    if (selectedProblemIndex === null && contestData.problems.length > 0) {
                        selectProblem(0);
                    } else if (selectedProblemIndex !== null) {
                        selectProblem(selectedProblemIndex); // Refresh UI state for current selection
                    }
                    
                    document.getElementById('loadingScreen').style.display = 'none';
                    if (!timerInterval) startContestTimer();
                }
            } catch (e) { setTimeout(loadContest, 3000); }
        }

        function toggleInputArea() {
            const area = document.getElementById('inputArea');
            area.style.display = document.getElementById('toggleCustomInput').checked ? 'block' : 'none';
            editor.refresh();
        }

        async function runCustomCode() {
            const code = editor.getValue();
            const stdin = document.getElementById('customStdin').value;
            const language = document.getElementById('langSelect').value;
            const outputBox = document.getElementById('outputBox');

            if (!code.trim()) return;
            outputBox.innerHTML = 'Executing...';

            try {
                const res = await fetch(`${API_URL}/student/execute`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ source_code: code, language_id: getLangId(language), stdin })
                });
                const result = await res.json();
                outputBox.innerHTML = `<div style="color:#10b981">Output:</div>${result.decodedStdout || result.decodedStderr || 'No output'}`;
            } catch (e) { outputBox.innerHTML = 'Execution failed.'; }
        }

        function getLangId(lang) {
            return lang === 'python' ? 71 : lang === 'cpp' ? 54 : 62;
        }

        async function runSampleTests() {
            const code = editor.getValue();
            const language = document.getElementById('langSelect').value;
            const outputBox = document.getElementById('outputBox');
            if (!code.trim()) return;
            outputBox.innerHTML = 'Running samples...';
            try {
                const res = await fetch(`${API_URL}/student/test-code`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ contest_id: contestId, problem_index: selectedProblemIndex, code, language })
                });
                const result = await res.json();
                let html = '<strong>SAMPLE RESULTS:</strong><br>';
                result.data.sample_results.forEach(r => {
                    html += `<span style="color:${r.passed ? '#10b981' : '#ef4444'}">${r.passed ? '✓' : '✗'} Case ${r.test_case}</span><br>`;
                });
                outputBox.innerHTML = html;
            } catch (e) { outputBox.innerHTML = 'Test failed.'; }
        }

        async function submitSolution() {
    const code = editor.getValue();
    if (!code.trim()) return;
    
    if (!confirm("Confirm submission? You will not be able to change your answer for this problem after clicking OK.")) return;

    try {
        const res = await fetch(`${API_URL}/student/submit-solution`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify({ 
                contest_id: contestId, 
                problem_index: selectedProblemIndex, 
                code, 
                language: document.getElementById('langSelect').value 
            })
        });
        const result = await res.json();
        
        if (result.success) {
            alert("Problem Submitted Successfully. This question is now locked.");
            await loadContest(); // This refreshes contestData and locks the UI
        }
    } catch (e) {
        alert("Error submitting solution.");
    }
}

        async function endContest() {
    if (!confirm("Are you sure you want to finish?")) return;

    try {
        // Refresh local data to match what the backend sees
        await loadContest(); 

        const ruleResponse = await fetch(`${API_URL}/student/progression-rules`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const ruleResult = await ruleResponse.json();
        const activeRule = (ruleResult.data || []).find(r => r.normal_contest_id === contestId);

        if (activeRule) {
            // Use the same math the backend uses
            const currentScore = contestData.student_progress.total_score || 0;
            const maxScore = contestData.student_progress.max_score || 1;
            const percentage = (currentScore / maxScore) * 100;

            if (percentage >= activeRule.passing_score) {
                alert(`Unlocked! Score: ${percentage.toFixed(1)}%`);
                // Delay redirect slightly to allow DynamoDB to finish writes
                setTimeout(() => {
                    window.location.href = `student-debug.html?id=${activeRule.debug_contest_id}`;
                }, 500);
                return;
            }
        }
        window.location.href = 'student_dashboard.html';
    } catch (e) {
        window.location.href = 'student_dashboard.html';
    }
}
        function selectProblem(index) {
    selectedProblemIndex = index;
    const prob = contestData.problems[index];
    
    // Check if problem should be locked
    // Logic: If there is a submission OR attempts >= 2, lock it.
    const hasSubmitted = prob.student_submission !== undefined || prob.passed;
    const attempts = prob.student_submission?.attempts || 0;
    const isLocked = hasSubmitted || attempts >= 2;

    document.getElementById('currentProblemTitle').innerText = prob.title;
    
    // UI Update for Sidebar
    renderProblemList();

    if (isLocked) {
        editor.setOption("readOnly", "nocursor");
        document.getElementById('mainSubmitBtn').disabled = true;
        document.getElementById('mainSubmitBtn').style.opacity = "0.5";
        document.getElementById('mainSubmitBtn').innerText = "Question Locked";
        document.getElementById('runBtn').disabled = true;
        document.getElementById('sampleBtn').disabled = true;
        document.getElementById('outputBox').innerHTML = `<div style="color:#ef4444; font-weight:bold;">
            <i class="fas fa-lock"></i> This problem is locked because you have already submitted an answer.
        </div>`;
    } else {
        editor.setOption("readOnly", false);
        document.getElementById('mainSubmitBtn').disabled = false;
        document.getElementById('mainSubmitBtn').style.opacity = "1";
        document.getElementById('mainSubmitBtn').innerText = "Submit Problem";
        document.getElementById('runBtn').disabled = false;
        document.getElementById('sampleBtn').disabled = false;
        document.getElementById('outputBox').innerText = "Ready for execution...";
    }

    // Load problem description
    const samples = prob.test_cases ? prob.test_cases.filter(tc => tc.is_sample) : [];
    let sHtml = '';
    samples.forEach((tc, i) => {
        sHtml += `<div class="sample-box"><strong>Sample ${i+1}</strong><br>Input: ${tc.input}<br>Output: ${tc.output}</div>`;
    });

    document.getElementById('problemDescription').innerHTML = `
        <h3>${prob.title}</h3>
        <p style="margin: 15px 0;">${prob.description}</p>
        ${sHtml}
    `;
    
    editor.setValue(localStorage.getItem(`draft_${contestId}_${index}`) || "");
}

        function renderProblemList() {
            const list = document.getElementById('problemList');
            list.innerHTML = contestData.problems.map((p, i) => {
                const attempts = p.student_submission?.attempts || 0;
                const isLocked = attempts >= 2 || p.passed;
                
                return `
                    <div class="problem-item ${selectedProblemIndex === i ? 'active' : ''} ${isLocked ? 'locked' : ''}" onclick="selectProblem(${i})">
                        <span class="status-dot ${p.passed ? 'status-passed' : (attempts >= 2 ? 'status-locked' : 'status-pending')}"></span>
                        <div style="flex: 1;">
                            <div style="display:flex; justify-content:space-between;">
                                <strong>${p.title}</strong>
                                ${attempts > 0 ? `<small style="color:${attempts >= 2 ? '#ef4444' : '#94a3b8'}">${attempts}/2</small>` : ''}
                            </div>
                            <small>${p.score} pts</small>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateScoreDisplay() {
            const prog = contestData.student_progress;
            document.getElementById('scoreDisplay').innerText = `Score: ${prog.total_score} / ${prog.max_score}`;
        }

        function startContestTimer() {
    // 20 Minute Countdown Logic
    const DURATION = 20 * 60 * 1000; 
    
    // Use a persistent start time in localStorage so refresh doesn't reset the 20 mins
    let startTime = localStorage.getItem(`start_${contestId}`);
    if (!startTime) {
        startTime = Date.now();
        localStorage.setItem(`start_${contestId}`, startTime);
    }
    
    timerInterval = setInterval(() => {
        const elapsed = Date.now() - parseInt(startTime);
        const remaining = DURATION - elapsed;
        
        if (remaining <= 0) {
            clearInterval(timerInterval);
            document.getElementById('timerText').innerText = "00:00";
            alert("Time is up! Your session has ended.");
            endContest();
            return;
        }
        
        const minutes = Math.floor(remaining / 60000);
        const seconds = Math.floor((remaining % 60000) / 1000);
        
        const timerText = document.getElementById('timerText');
        timerText.innerText = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        
        // Visual warnings
        if (minutes < 5) {
            document.getElementById('timerContainer').style.background = "#fff1f2";
            document.getElementById('timerContainer').style.color = "#ef4444";
        }
    }, 1000);
}

        function exitContest() {
            if (confirm("Exit IDE? Your current draft is saved, but time continues.")) window.location.href = 'student_dashboard.html';
        }

        window.onload = init;
    </script>
</body>
</html>
